(()=>{"use strict";var e={858:function(e,n){var t=this&&this.__spreadArray||function(e,n,t){if(t||2===arguments.length)for(var i,r=0,u=n.length;r<u;r++)!i&&r in n||(i||(i=Array.prototype.slice.call(n,0,r)),i[r]=n[r]);return e.concat(i||Array.prototype.slice.call(n))};Object.defineProperty(n,"__esModule",{value:!0}),n.progress=void 0,n.progress=function(e){var n=new e.Logger("progress"),i=e.Replicant("rank-progress",{defaultValue:[]}),r=e.Replicant("checkpoint-results"),u=e.bundleConfig.games;r.on("change",(function(e){var r;r=e.reduce((function(e,n,i){var r=n.some((function(e){return e.some((function(e){return!!e}))}));return r?t(t([],e,!0),n.map((function(e,n){var r,o,l="".concat(null===(o=null===(r=null==u?void 0:u[i])||void 0===r?void 0:r.segments)||void 0===o?void 0:o[n]),a=t([],e.map((function(e){var n;return null!==(n=null==e?void 0:e.time)&&void 0!==n?n:1/0})),!0).sort((function(e,n){return e-n}));return{label:l,ranks:e.map((function(e){return e?a.indexOf(e.time)+1:null}))}})).filter((function(e){return e.ranks.some((function(e){return e}))})),!0):e}),[]),i.value=r,n.debug("Update progress to ".concat(JSON.stringify(r)))}))}},494:function(e,n,t){var i=this&&this.__spreadArray||function(e,n,t){if(t||2===arguments.length)for(var i,r=0,u=n.length;r<u;r++)!i&&r in n||(i||(i=Array.prototype.slice.call(n,0,r)),i[r]=n[r]);return e.concat(i||Array.prototype.slice.call(n))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.summary=void 0;var u=r(t(739)),o=t(547);n.summary=function(e,n){var t=new e.Logger("summary"),r=e.Replicant("latest-checkpoints",{defaultValue:null}),l=e.Replicant("total-times",{defaultValue:[]}),a=e.Replicant("current-checkpoints",{defaultValue:[]}),d=e.Replicant("checkpoint-results"),s=e.bundleConfig.games,c=e.bundleConfig.teams,v=function(e,n){return s.slice(0,e).reduce((function(e,n){return e+n.segments.length}),0)+n};d.on("change",(function(e){var d,f,m;!function(e){var l=(0,u.default)(e),a=l.flatMap((function(e,n){return e.map((function(e,t){return e.some((function(e){return!e}))?null:[n,t]}))})).filter((function(e){return!!e})),d=a.slice(-1)[0];if(d){var s=d[0],v=d[1],f=c.map((function(e,n){return l.map((function(e,t){return e.map((function(e,i){return t<s?null==e?void 0:e[n]:t===s?i>v?null:null==e?void 0:e[n]:null}))}))})),m=f.map((function(e){return n.calculateTotal(e)})),p=i([],m,!0).sort((function(e,n){return e-n})),g=p[0];r.value={segment:{game:s,index:v},times:m.map((function(e){return{rank:p.indexOf(e)+1,time:(0,o.toDisplayedTime)(e),diffInSeconds:e-g}}))},t.debug("Set latest ".concat(JSON.stringify(r.value)))}else r.value=null}(e),d=e,f=(0,u.default)(d),m=s.map((function(e,t){var i=f.filter((function(e,n){return!(n>t)}));return c.map((function(e,t){var r=n.calculateTotal(i.map((function(e){return e.map((function(e){return null==e?void 0:e[t]}))})));return{time:r,displayedTime:(0,o.toDisplayedTime)(r)}}))})),l.value=m,t.debug("Set total times ".concat(JSON.stringify(m))),function(e){var n=(0,u.default)(e),i=c.map((function(e,t){var i,r,u,o,l,a,d,c,f,m,p=n.flatMap((function(e,n){return e.map((function(e,i){return[null==e?void 0:e[t],[n,i]]}))})).filter((function(e){return!!e[0]})),g=p.slice(-1)[0];if(!g)return{isDone:!1,game:0,label:null===(r=null===(i=null==s?void 0:s[0])||void 0===i?void 0:i.segments)||void 0===r?void 0:r[0],totalSegments:0};var y=g[1],h=y[0],_=y[1];if(!(null===(o=null===(u=s[h])||void 0===u?void 0:u.segments)||void 0===o?void 0:o[_+1])&&!s[h+1])return{isDone:!0,game:h,label:"完走！！！",totalSegments:v(h,_)+1};var S=(null===(a=null===(l=null==s?void 0:s[h])||void 0===l?void 0:l.segments)||void 0===a?void 0:a[_+1])?h:h+1,b=(null===(c=null===(d=null==s?void 0:s[h])||void 0===d?void 0:d.segments)||void 0===c?void 0:c[_+1])?_+1:0;return{isDone:!1,game:S,label:null===(m=null===(f=null==s?void 0:s[S])||void 0===f?void 0:f.segments)||void 0===m?void 0:m[b],totalSegments:v(S,b)}})),r=i.map((function(e){return e.totalSegments})),o=Math.max.apply(Math,r);a.value=i.map((function(e){var n=e.isDone,t=e.label,i=e.game,r=e.totalSegments;return{isDone:n,label:t,game:i,diffCpCount:o-r}})),t.debug("Set current cps ".concat(JSON.stringify(a.value)))}(e)}))}},746:(e,n)=>{Object.defineProperty(n,"__esModule",{value:!0}),n.SumOfGameResults=void 0,n.SumOfGameResults={calculateTotal:function(e){return e.map((function(e){return e.filter((function(e){return!!e})).slice(-1)[0]})).reduce((function(e,n){var t;return e+(null!==(t=null==n?void 0:n.time)&&void 0!==t?t:0)}),0)}}},180:function(e,n,t){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.timekeeping=void 0;var r=i(t(739)),u=t(547);n.timekeeping=function(e){var n=new e.Logger("timekeeping"),t=e.Replicant("checkpoint-results",{defaultValue:[]}),i=e.bundleConfig.games,o=e.bundleConfig.teams,l=function(e){void 0===e&&(e=!1);var n=e?[]:(0,r.default)(t.value);t.value=i.map((function(e,t){return e.segments.map((function(e,i){return o.map((function(e,r){var u,o,l;return null!==(l=null===(o=null===(u=null==n?void 0:n[t])||void 0===u?void 0:u[i])||void 0===o?void 0:o[r])&&void 0!==l?l:null}))}))}))};l(),e.listenFor("timekeeping:record",(function(e,i){var r,o,l,a,d,s,c;i&&i.handled||(r=e.time,o=e.indexes.game,l=e.indexes.segment,a=e.indexes.team,void 0!==(null===(c=null===(s=null===(d=t.value)||void 0===d?void 0:d[o])||void 0===s?void 0:s[l])||void 0===c?void 0:c[a])&&(t.value[o][l][a]={time:r,displayedTime:(0,u.toDisplayedTime)(r)},n.debug("Set ".concat(JSON.stringify({time:r,displayedTime:(0,u.toDisplayedTime)(r)})))))})),e.listenFor("timekeeping:delete",(function(e,i){var r,u,o,l,a,d;i&&i.handled||(r=e.indexes.game,u=e.indexes.segment,o=e.indexes.team,void 0!==(null===(d=null===(a=null===(l=t.value)||void 0===l?void 0:l[r])||void 0===a?void 0:a[u])||void 0===d?void 0:d[o])&&(t.value[r][u][o]=null,n.debug("Delete ".concat(JSON.stringify({game:r,segment:u,team:o})))))})),e.listenFor("timekeeping:reset",(function(e,n){n&&n.handled||l(!0)}))}},523:(e,n,t)=>{Object.defineProperty(n,"__esModule",{value:!0}),n.timer=void 0;var i=t(547);n.timer=function(e){var n=e.Replicant("timer",{defaultValue:{startAt:0,time:{inSecond:0,displayed:""}}});setInterval((function(){!function(e){if(n.value){var t=e-n.value.startAt,r=Math.floor(t/1e3);n.value.time={inSecond:r,displayed:"".concat(r<0?"-":"").concat((0,i.toDisplayedTime)(Math.abs(r)))}}}(Date.now())}),100),e.listenFor("timer:updateStartAt",(function(e,t){var i;t&&t.handled||(i=e,n.value&&(n.value.startAt=i))}))}},547:function(e,n,t){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.toDisplayedTime=void 0;var r=i(t(245));n.toDisplayedTime=function(e){var n=r.default.duration(e,"seconds");return"".concat(Math.floor(n.asHours()),":").concat(String(n.minutes()).padStart(2,"0"),":").concat(String(n.seconds()).padStart(2,"0"))}},739:e=>{e.exports=require("clone")},245:e=>{e.exports=require("moment")}},n={};function t(i){var r=n[i];if(void 0!==r)return r.exports;var u=n[i]={exports:{}};return e[i].call(u.exports,u,u.exports,t),u.exports}var i={};(()=>{var e=i;Object.defineProperty(e,"__esModule",{value:!0});var n=t(858),r=t(494),u=t(746),o=t(180),l=t(523);e.default=function(e){(0,o.timekeeping)(e),(0,r.summary)(e,u.SumOfGameResults),(0,n.progress)(e),(0,l.timer)(e)}})(),module.exports=i})();