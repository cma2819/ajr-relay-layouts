(()=>{"use strict";var e={858:function(e,n){var t=this&&this.__spreadArray||function(e,n,t){if(t||2===arguments.length)for(var i,u=0,r=n.length;u<r;u++)!i&&u in n||(i||(i=Array.prototype.slice.call(n,0,u)),i[u]=n[u]);return e.concat(i||Array.prototype.slice.call(n))};Object.defineProperty(n,"__esModule",{value:!0}),n.progress=void 0,n.progress=function(e){var n=new e.Logger("progress"),i=e.Replicant("rank-progress",{defaultValue:[]}),u=e.Replicant("checkpoint-results"),r=e.bundleConfig.games,l=function(e,n,t,i){return e.reduce((function(e,u,r){var l,o,a,d,s;if(r>n)return e;if(r===n)return e+(null!==(a=null===(o=null===(l=null==u?void 0:u[t])||void 0===l?void 0:l[i])||void 0===o?void 0:o.time)&&void 0!==a?a:0);var c=u.slice(-1)[0];return e+(null!==(s=null===(d=null==c?void 0:c[i])||void 0===d?void 0:d.time)&&void 0!==s?s:0)}),0)};u.on("change",(function(e){var u,o;o=(u=e).reduce((function(e,n,i){return n.some((function(e){return e.some((function(e){return!!e}))}))?t(t([],e,!0),n.map((function(e,n){var o,a,d="".concat(null===(a=null===(o=null==r?void 0:r[i])||void 0===o?void 0:o.segments)||void 0===a?void 0:a[n]),s=t([],e.map((function(e,t){return(null==e?void 0:e.time)?l(u,i,n,t):Number.MAX_VALUE})),!0).sort((function(e,n){return e-n}));return{label:d,ranks:e.map((function(e,t){return e?s.indexOf(l(u,i,n,t))+1:null}))}})).filter((function(e){return e.ranks.some((function(e){return e}))})),!0):e}),[]),i.value=o,n.debug("Update progress to ".concat(JSON.stringify(o)))}))}},494:function(e,n,t){var i=this&&this.__spreadArray||function(e,n,t){if(t||2===arguments.length)for(var i,u=0,r=n.length;u<r;u++)!i&&u in n||(i||(i=Array.prototype.slice.call(n,0,u)),i[u]=n[u]);return e.concat(i||Array.prototype.slice.call(n))},u=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.summary=void 0;var r=u(t(739)),l=t(547);n.summary=function(e,n){var t=new e.Logger("summary"),u=e.Replicant("latest-checkpoints",{defaultValue:null}),o=e.Replicant("total-times",{defaultValue:[]}),a=e.Replicant("current-checkpoints",{defaultValue:[]}),d=e.Replicant("checkpoint-results"),s=e.bundleConfig.games,c=e.bundleConfig.teams,v=function(e,n){return s.slice(0,e).reduce((function(e,n){return e+n.segments.length}),0)+n};d.on("change",(function(e){var d,f,m;!function(e){var o=(0,r.default)(e),a=o.flatMap((function(e,n){return e.map((function(e,t){return e.some((function(e){return!e}))?null:[n,t]}))})).filter((function(e){return!!e})),d=a.slice(-1)[0];if(d){var s=d[0],v=d[1],f=c.map((function(e,n){return o.map((function(e,t){return e.map((function(e,i){return t<s?null==e?void 0:e[n]:t===s?i>v?null:null==e?void 0:e[n]:null}))}))})),m=f.map((function(e){return n.calculateTotal(e)})),p=i([],m,!0).sort((function(e,n){return e-n})),g=p[0];u.value={segment:{game:s,index:v},times:m.map((function(e){return{rank:p.indexOf(e)+1,time:(0,l.toDisplayedTime)(e),diffInSeconds:e-g}}))},t.debug("Set latest ".concat(JSON.stringify(u.value)))}else u.value=null}(e),d=e,f=(0,r.default)(d),m=s.map((function(e,t){var i=f.filter((function(e,n){return!(n>t)}));return c.map((function(e,t){var u=n.calculateTotal(i.map((function(e){return e.map((function(e){return null==e?void 0:e[t]}))})));return{time:u,displayedTime:(0,l.toDisplayedTime)(u)}}))})),o.value=m,t.debug("Set total times ".concat(JSON.stringify(m))),function(e){var n=(0,r.default)(e),i=c.map((function(e,t){var i,u,r,l,o,a,d,c,f,m,p=n.flatMap((function(e,n){return e.map((function(e,i){return[null==e?void 0:e[t],[n,i]]}))})).filter((function(e){return!!e[0]})),g=p.slice(-1)[0];if(!g)return{isDone:!1,game:0,label:null===(u=null===(i=null==s?void 0:s[0])||void 0===i?void 0:i.segments)||void 0===u?void 0:u[0],totalSegments:0};var y=g[1],h=y[0],_=y[1];if(!(null===(l=null===(r=s[h])||void 0===r?void 0:r.segments)||void 0===l?void 0:l[_+1])&&!s[h+1])return{isDone:!0,game:h,label:"完走！！！",totalSegments:v(h,_)+1};var b=(null===(a=null===(o=null==s?void 0:s[h])||void 0===o?void 0:o.segments)||void 0===a?void 0:a[_+1])?h:h+1,S=(null===(c=null===(d=null==s?void 0:s[h])||void 0===d?void 0:d.segments)||void 0===c?void 0:c[_+1])?_+1:0;return{isDone:!1,game:b,label:null===(m=null===(f=null==s?void 0:s[b])||void 0===f?void 0:f.segments)||void 0===m?void 0:m[S],totalSegments:v(b,S)}})),u=i.map((function(e){return e.totalSegments})),l=Math.max.apply(Math,u);a.value=i.map((function(e){var n=e.isDone,t=e.label,i=e.game,u=e.totalSegments;return{isDone:n,label:t,game:i,diffCpCount:l-u}})),t.debug("Set current cps ".concat(JSON.stringify(a.value)))}(e)}))}},746:(e,n)=>{Object.defineProperty(n,"__esModule",{value:!0}),n.SumOfGameResults=void 0,n.SumOfGameResults={calculateTotal:function(e){return e.map((function(e){return e.filter((function(e){return!!e})).slice(-1)[0]})).reduce((function(e,n){var t;return e+(null!==(t=null==n?void 0:n.time)&&void 0!==t?t:0)}),0)}}},180:function(e,n,t){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.timekeeping=void 0;var u=i(t(739)),r=t(547);n.timekeeping=function(e){var n=new e.Logger("timekeeping"),t=e.Replicant("checkpoint-results",{defaultValue:[]}),i=e.bundleConfig.games,l=e.bundleConfig.teams,o=function(e){void 0===e&&(e=!1);var n=e?[]:(0,u.default)(t.value);t.value=i.map((function(e,t){return e.segments.map((function(e,i){return l.map((function(e,u){var r,l,o;return null!==(o=null===(l=null===(r=null==n?void 0:n[t])||void 0===r?void 0:r[i])||void 0===l?void 0:l[u])&&void 0!==o?o:null}))}))}))};o(),e.listenFor("timekeeping:record",(function(e,i){var u,l,o,a,d,s,c;i&&i.handled||(u=e.time,l=e.indexes.game,o=e.indexes.segment,a=e.indexes.team,void 0!==(null===(c=null===(s=null===(d=t.value)||void 0===d?void 0:d[l])||void 0===s?void 0:s[o])||void 0===c?void 0:c[a])&&(t.value[l][o][a]={time:u,displayedTime:(0,r.toDisplayedTime)(u)},n.debug("Set ".concat(JSON.stringify({time:u,displayedTime:(0,r.toDisplayedTime)(u)})))))})),e.listenFor("timekeeping:delete",(function(e,i){var u,r,l,o,a,d;i&&i.handled||(u=e.indexes.game,r=e.indexes.segment,l=e.indexes.team,void 0!==(null===(d=null===(a=null===(o=t.value)||void 0===o?void 0:o[u])||void 0===a?void 0:a[r])||void 0===d?void 0:d[l])&&(t.value[u][r][l]=null,n.debug("Delete ".concat(JSON.stringify({game:u,segment:r,team:l})))))})),e.listenFor("timekeeping:reset",(function(e,n){n&&n.handled||o(!0)}))}},523:(e,n,t)=>{Object.defineProperty(n,"__esModule",{value:!0}),n.timer=void 0;var i=t(547);n.timer=function(e){var n=e.Replicant("timer",{defaultValue:{startAt:0,time:{inSecond:0,displayed:""}}});setInterval((function(){!function(e){if(n.value){var t=e-n.value.startAt,u=Math.floor(t/1e3);n.value.time={inSecond:u,displayed:"".concat(u<0?"-":"").concat((0,i.toDisplayedTime)(Math.abs(u)))}}}(Date.now())}),100),e.listenFor("timer:updateStartAt",(function(e,t){var i;t&&t.handled||(i=e,n.value&&(n.value.startAt=i))}))}},547:function(e,n,t){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.toDisplayedTime=void 0;var u=i(t(245));n.toDisplayedTime=function(e){var n=u.default.duration(e,"seconds");return"".concat(Math.floor(n.asHours()),":").concat(String(n.minutes()).padStart(2,"0"),":").concat(String(n.seconds()).padStart(2,"0"))}},739:e=>{e.exports=require("clone")},245:e=>{e.exports=require("moment")}},n={};function t(i){var u=n[i];if(void 0!==u)return u.exports;var r=n[i]={exports:{}};return e[i].call(r.exports,r,r.exports,t),r.exports}var i={};(()=>{var e=i;Object.defineProperty(e,"__esModule",{value:!0});var n=t(858),u=t(494),r=t(746),l=t(180),o=t(523);e.default=function(e){(0,l.timekeeping)(e),(0,u.summary)(e,r.SumOfGameResults),(0,n.progress)(e),(0,o.timer)(e)}})(),module.exports=i})();