(()=>{"use strict";var e={858:function(e,n){var t=this&&this.__spreadArray||function(e,n,t){if(t||2===arguments.length)for(var i,r=0,o=n.length;r<o;r++)!i&&r in n||(i||(i=Array.prototype.slice.call(n,0,r)),i[r]=n[r]);return e.concat(i||Array.prototype.slice.call(n))};Object.defineProperty(n,"__esModule",{value:!0}),n.progress=void 0,n.progress=function(e){var n=new e.Logger("progress"),i=e.Replicant("rank-progress",{defaultValue:[]}),r=e.Replicant("checkpoint-results"),o=e.bundleConfig.games;r.on("change",(function(e){var r;r=e.reduce((function(e,n,i){var r=n.some((function(e){return e.some((function(e){return!!e}))}));return r?t(t([],e,!0),n.map((function(e,n){var r,a,u="".concat(null===(a=null===(r=null==o?void 0:o[i])||void 0===r?void 0:r.segments)||void 0===a?void 0:a[n]),l=t([],e.map((function(e){var n;return null!==(n=null==e?void 0:e.time)&&void 0!==n?n:1/0})),!0).sort((function(e,n){return e-n}));return{label:u,ranks:e.map((function(e){return e?l.indexOf(e.time)+1:null}))}})).filter((function(e){return e.ranks.some((function(e){return e}))})),!0):e}),[]),i.value=r,n.debug("Update progress to ".concat(JSON.stringify(r)))}))}},494:function(e,n,t){var i=this&&this.__spreadArray||function(e,n,t){if(t||2===arguments.length)for(var i,r=0,o=n.length;r<o;r++)!i&&r in n||(i||(i=Array.prototype.slice.call(n,0,r)),i[r]=n[r]);return e.concat(i||Array.prototype.slice.call(n))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.summary=void 0;var o=r(t(739)),a=t(547);n.summary=function(e,n){var t=new e.Logger("summary"),r=e.Replicant("latest-checkpoints",{defaultValue:null}),u=e.Replicant("total-times",{defaultValue:[]}),l=e.Replicant("current-checkpoints",{defaultValue:[]}),c=e.Replicant("checkpoint-results"),s=e.bundleConfig.games,d=e.bundleConfig.teams,v=function(e,n){return s.slice(0,e).reduce((function(e,n){return e+n.segments.length}),0)+n};c.on("change",(function(e){var c,f,m;!function(e){var u=(0,o.default)(e),l=u.flatMap((function(e,n){return e.map((function(e,t){return e.some((function(e){return!e}))?null:[n,t]}))})).filter((function(e){return!!e})),c=l.slice(-1)[0];if(c){var s=c[0],v=c[1],f=d.map((function(e,n){return u.map((function(e,t){return e.map((function(e,i){return t<s?null==e?void 0:e[n]:t===s?i>v?null:null==e?void 0:e[n]:null}))}))})),m=f.map((function(e){return n.calculateTotal(e)})),p=i([],m,!0).sort((function(e,n){return e-n})),g=p[0];r.value={segment:{game:s,index:v},times:m.map((function(e){return{rank:p.indexOf(e)+1,time:(0,a.toDisplayedTime)(e),diffInSeconds:e-g}}))},t.debug("Set latest ".concat(JSON.stringify(r.value)))}else r.value=null}(e),c=e,f=(0,o.default)(c),m=s.map((function(e,t){var i=f.filter((function(e,n){return!(n>t)}));return d.map((function(e,t){var r=n.calculateTotal(i.map((function(e){return e.map((function(e){return null==e?void 0:e[t]}))})));return{time:r,displayedTime:(0,a.toDisplayedTime)(r)}}))})),u.value=m,t.debug("Set total times ".concat(JSON.stringify(m))),function(e){var n=(0,o.default)(e),i=d.map((function(e,t){var i,r,o,a,u,l,c,d,f,m,p=n.flatMap((function(e,n){return e.map((function(e,i){return[null==e?void 0:e[t],[n,i]]}))})).filter((function(e){return!!e[0]})),g=p.slice(-1)[0];if(!g)return{isDone:!1,game:0,label:null===(r=null===(i=null==s?void 0:s[0])||void 0===i?void 0:i.segments)||void 0===r?void 0:r[0],totalSegments:0};var y=g[1],h=y[0],b=y[1];if(!(null===(a=null===(o=s[h])||void 0===o?void 0:o.segments)||void 0===a?void 0:a[b+1])&&!s[h+1])return{isDone:!0,game:h,label:"完走！！！",totalSegments:v(h,b)+1};var _=(null===(l=null===(u=null==s?void 0:s[h])||void 0===u?void 0:u.segments)||void 0===l?void 0:l[b+1])?h:h+1,S=(null===(d=null===(c=null==s?void 0:s[h])||void 0===c?void 0:c.segments)||void 0===d?void 0:d[b+1])?b+1:0;return{isDone:!1,game:_,label:null===(m=null===(f=null==s?void 0:s[_])||void 0===f?void 0:f.segments)||void 0===m?void 0:m[S],totalSegments:v(_,S)}})),r=i.map((function(e){return e.totalSegments})),a=Math.max.apply(Math,r);l.value=i.map((function(e){var n=e.isDone,t=e.label,i=e.game,r=e.totalSegments;return{isDone:n,label:t,game:i,diffCpCount:a-r}})),t.debug("Set current cps ".concat(JSON.stringify(l.value)))}(e)}))}},746:(e,n)=>{Object.defineProperty(n,"__esModule",{value:!0}),n.SumOfGameResults=void 0,n.SumOfGameResults={calculateTotal:function(e){return e.map((function(e){return e.filter((function(e){return!!e})).slice(-1)[0]})).reduce((function(e,n){var t;return e+(null!==(t=null==n?void 0:n.time)&&void 0!==t?t:0)}),0)}}},180:function(e,n,t){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.timekeeping=void 0;var r=i(t(739)),o=t(547);n.timekeeping=function(e){var n=new e.Logger("timekeeping"),t=e.Replicant("checkpoint-results",{defaultValue:[]}),i=e.bundleConfig.games,a=e.bundleConfig.teams,u=function(e){void 0===e&&(e=!1);var n=e?[]:(0,r.default)(t.value);t.value=i.map((function(e,t){return e.segments.map((function(e,i){return a.map((function(e,r){var o,a,u;return null!==(u=null===(a=null===(o=null==n?void 0:n[t])||void 0===o?void 0:o[i])||void 0===a?void 0:a[r])&&void 0!==u?u:null}))}))}))};u(),e.listenFor("timekeeping:record",(function(e,i){var r,a,u,l,c,s,d;i&&i.handled||(r=e.time,a=e.indexes.game,u=e.indexes.segment,l=e.indexes.team,void 0!==(null===(d=null===(s=null===(c=t.value)||void 0===c?void 0:c[a])||void 0===s?void 0:s[u])||void 0===d?void 0:d[l])&&(t.value[a][u][l]={time:r,displayedTime:(0,o.toDisplayedTime)(r)},n.debug("Set ".concat(JSON.stringify({time:r,displayedTime:(0,o.toDisplayedTime)(r)})))))})),e.listenFor("timekeeping:delete",(function(e,i){var r,o,a,u,l,c;i&&i.handled||(r=e.indexes.game,o=e.indexes.segment,a=e.indexes.team,void 0!==(null===(c=null===(l=null===(u=t.value)||void 0===u?void 0:u[r])||void 0===l?void 0:l[o])||void 0===c?void 0:c[a])&&(t.value[r][o][a]=null,n.debug("Delete ".concat(JSON.stringify({game:r,segment:o,team:a})))))})),e.listenFor("timekeeping:reset",(function(e,n){n&&n.handled||u(!0)}))}},523:(e,n,t)=>{Object.defineProperty(n,"__esModule",{value:!0}),n.timer=void 0;var i=t(547);n.timer=function(e){var n=e.Replicant("timer",{defaultValue:{startAt:0,time:{inSecond:0,displayed:""}}});setInterval((function(){!function(e){if(n.value){var t=e-n.value.startAt,r=Math.floor(t/1e3);n.value.time={inSecond:r,displayed:"".concat(r<0?"-":"").concat((0,i.toDisplayedTime)(Math.abs(r)))}}}(Date.now())}),100),e.listenFor("timer:updateStartAt",(function(e,t){var i;t&&t.handled||(i=e,n.value&&(n.value.startAt=i))}))}},547:function(e,n,t){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0}),n.toDisplayedTime=void 0;var r=i(t(245));n.toDisplayedTime=function(e){var n=r.default.duration(e,"seconds");return"".concat(Math.floor(n.asHours()),":").concat(String(n.minutes()).padStart(2,"0"),":").concat(String(n.seconds()).padStart(2,"0"))}},485:function(e,n,t){var i=this&&this.__awaiter||function(e,n,t,i){return new(t||(t=Promise))((function(r,o){function a(e){try{l(i.next(e))}catch(e){o(e)}}function u(e){try{l(i.throw(e))}catch(e){o(e)}}function l(e){var n;e.done?r(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(a,u)}l((i=i.apply(e,n||[])).next())}))},r=this&&this.__generator||function(e,n){var t,i,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(u){return function(l){return function(u){if(t)throw new TypeError("Generator is already executing.");for(;o&&(o=0,u[0]&&(a=0)),a;)try{if(t=1,i&&(r=2&u[0]?i.return:u[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,u[1])).done)return r;switch(i=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return a.label++,{value:u[1],done:!1};case 5:a.label++,i=u[1],u=[0];continue;case 7:u=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==u[0]&&2!==u[0])){a=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){a.label=u[1];break}if(6===u[0]&&a.label<r[1]){a.label=r[1],r=u;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(u);break}r[2]&&a.ops.pop(),a.trys.pop();continue}u=n.call(e,a)}catch(e){u=[6,e],i=0}finally{t=r=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,l])}}};Object.defineProperty(n,"__esModule",{value:!0}),n.voiceChannel=void 0;var o=t(349),a=t(117);n.voiceChannel=function(e){var n=new e.Logger("discord"),t=e.bundleConfig.discord,u=e.Replicant("commentators",{defaultValue:[]}),l=new o.Client({intents:[o.GatewayIntentBits.Guilds,o.GatewayIntentBits.GuildMessages,o.GatewayIntentBits.GuildVoiceStates,o.GatewayIntentBits.MessageContent]}),c=function(e){return i(void 0,void 0,void 0,(function(){return r(this,(function(n){return[2,(0,a.joinVoiceChannel)({channelId:e.id,guildId:e.guild.id,adapterCreator:e.guild.voiceAdapterCreator})]}))}))};l.on("ready",(function(){n.info("Ready to join discord bot")})),l.on("messageCreate",(function(e){return i(void 0,void 0,void 0,(function(){var i,o,a;return r(this,(function(r){switch(r.label){case 0:if(n.debug("Get message ".concat(JSON.stringify(e))),!e.guild||e.channelId!==t.commandChannelId)return[2];if("-invite"!==e.content)return[3,4];if(i=null===(a=e.member)||void 0===a?void 0:a.voice.channel,n.debug("Received invite message, channel is ".concat(i)),!i)return[3,4];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,c(i)];case 2:return r.sent(),setInterval((function(){var i,r,o,a,l=null!==(a=null===(o=null===(r=null===(i=e.member)||void 0===i?void 0:i.voice.channel)||void 0===r?void 0:r.members)||void 0===o?void 0:o.map((function(e){var n;return{pk:e.id,name:e.displayName,avatar:null!==(n=e.avatarURL({extension:"png"}))&&void 0!==n?n:""}})).filter((function(e){return e.pk!==t.botId})))&&void 0!==a?a:[];u.value=l,n.debug("Set commentators as ".concat(JSON.stringify(l)))}),1e3),[3,4];case 3:return o=r.sent(),n.error(o),[3,4];case 4:return[2]}}))}))})),l.login(t.token)}},117:e=>{e.exports=require("@discordjs/voice")},739:e=>{e.exports=require("clone")},349:e=>{e.exports=require("discord.js")},245:e=>{e.exports=require("moment")}},n={};function t(i){var r=n[i];if(void 0!==r)return r.exports;var o=n[i]={exports:{}};return e[i].call(o.exports,o,o.exports,t),o.exports}var i={};(()=>{var e=i;Object.defineProperty(e,"__esModule",{value:!0});var n=t(485),r=t(858),o=t(494),a=t(746),u=t(180),l=t(523);e.default=function(e){(0,u.timekeeping)(e),(0,o.summary)(e,a.SumOfGameResults),(0,r.progress)(e),(0,l.timer)(e),(0,n.voiceChannel)(e)}})(),module.exports=i})();